---
title: '从绘板到跑路: 基于IAP15F2K61S2芯片的单片机折腾笔记'
date: 2022-07-14 15:05:55
tags: [ '单片机' ]
mathjax: true
---

# 一、前言
最近有个项目需要一块专用单片机用于实现PWM调频、电量测量（实际上是电压测量）、光照测量、485以及串口通信，并且项目代码基于学校老师封装的BSP，由于其是为基于IAP15F2K61S2芯片设计的开发板，因此打算基于同款芯片重新设计一块。

# 二、工具
工欲善其事，必先利其器。
1. PCB设计工具。这里采用老师推荐的[嘉立创EDA](https://lceda.cn/)。
2. Money。

# 三、绘制原理图
原理图是设计流程中的基础，它是最终单片机上的一个个模块电路。由于是基于学校的开发板，因此可以借鉴其部分原理图。

## 1. 芯片
### a) 查看原版原理图
{% asset_img 芯片1.png 芯片1 %}

### b) 添加元件
打开嘉立创EDA，新建好工程后创建第一张原理图，然后打开元件库
{% asset_img 元件库.png 元件库 %}
搜索`IAP15F2K61S2 LQFP44`
{% asset_img 搜索芯片.png 搜索芯片 %}
在添加元件时，最好选择立创商城的元件，这样在购买的时候比较方便。

### c) 绘制原理图
将其放置在原理图上，根据实际需求修改引脚：
- PWM调频需要用到PCA模块，因此引出4、5号引脚
- 电量测量以及光照测量需要用到模数转换器（ADC），因此引出7、8、9号引脚
- 485通信需要接收/发送数据以及使能信号，因此分别引出38、6、25号引脚
- 串口通信需要接收/发送数据，因此分别引出18、19号引脚
{% asset_img 芯片2.png 芯片2 %}
这里芯片的`VCC`引脚和`GND`引脚之间连接了一个`104`的电容，而`104`指的是
$$
10×10^{4}pF
$$
即
$$
100nF
$$
它的作用实际上是过滤电路中的高频噪声。

## 2. USB
### a) 查看原版原理图
{% asset_img USB1.png USB1 %}
右上角是FM收音机模块的一部分，而这里不需要用到它。

### b) 绘制原理图
{% asset_img USB2.png USB2 %}
添加好元件后就可以绘制原理图了，这里把接口换成了Type-C（使用倒是方便，但非常难焊）。

## 3. 485
### a) 查看原版原理图
{% asset_img 485_1.png 485_1 %}

### b) 绘制原理图
{% asset_img 485_2.png 485_2 %}

## 4. PWM
### a) 绘制原理图
下图存在部分错误，会在后文中指出。
{% asset_img PWM.png PWM %}
由于可以通过芯片在软件层实现PCA调频，因此可以借助MOS管导通特性，从而将输入的12V进行调频。
将P1.0/P1.1口接入NMOS管的栅极，12V外部输入接入PMOS管的源极，当P1.0/P1.1输入高电平时NMOS管源极和漏极导通，PMOS管栅极相当于接地，其源极和漏极导通，从而使12V输出到漏极，通过对导通时间与周期的比例（即占空比）的控制，即可控制输出电压。
其中二极管接地的作用是稳压和保护，防止反向击穿；电感通直流，阻交流；电容接地则是滤波。

## 5. 电量（电压）测量
### a) 绘制原理图
{% asset_img 电压.png 电压 %}
V_Voltage0/V_Voltage1得到的值是2k电阻的电压，因此将值除以2乘以20即为所测电压。

## 6. 光照测量
### a) 查看原版原理图
{% asset_img ROP1.png ROP1 %}

### b) 绘制原理图
{% asset_img ROP2.png ROP2 %}
这里没有直接接入光敏电阻，而是改成用连接器外接。

# 四、绘制PCB
PCB设计是设计流程中的重要环节，它决定了最终成品板的模样。

## 1. 原理图转PCB
将所有原理图绘制完成后，可以打开左侧工具栏中的设计管理器，检查是否还有未连接网络。
{% asset_img 设计管理器.png 设计管理器 %}
检查完成之后，单击设计 - 原理图转PCB或者快捷工具栏对应的图标，将原理图转为PCB。
后续如果原理图有更改，则可以选择更新PCB。
{% asset_img 转PCB.png 转PCB %}

## 2. 绘制
首先根据实际情况填写参数，新建PCB。
{% asset_img 新建PCB.png 新建PCB %}
新建好后，就可以对PCB进行设计了。
{% asset_img 初始PCB.png 初始PCB %}
每个人的设计风格和理念都不同，但仍需要遵守一定的准则，以保证开发板的稳定性。

### a) 绘制步骤
根据原理图进行大致布局 → 微调元件位置 → 根据需要可选择放置焊盘 → 连线 → 微调元件位号位置，适当添加引脚标识（如GND等） → 添加泪滴（增强连线稳定性） → 铺铜（增强散热、屏蔽、保证PCB工艺电镀效果等）

### b) 注意事项
- 尽量保证每个模块电路中的元件靠近，使得传输距离更短，更稳定，并且连线时更简单。
- 连线时切忌直角转弯，应更平滑。
错误：
{% asset_img 直角转弯.png 直角转弯 %}
正确：
{% asset_img 非直角转弯.png 非直角转弯 %}
- 在条件允许的情况下尽量增大导线的线宽。
- 布局时应考虑部分元件对电路的影响，例如考虑晶振对电路的辐射作用，将其布局在开发板边缘位置更好。
- 正面无法继续连线时，可放置过孔在背面继续连线。应注意立创EDA默认的过孔直径不满足DRC检查，可适当调整。
- 铺铜不是必要的，但一般的电路板中铺铜更好。可对某部分特殊网络进行铺铜，例如本开发板背面对GND，正面对VUSB、VCC、+12V铺铜。此外铺铜间距不应太小，因为PCB工艺可能会有偏差。
{% asset_img 铺铜.png 铺铜 %}

### c) 查看成品
绘制完成后，可以查看成品的各种样图。
{% asset_img 成品PCB.png 成品PCB %}
{% asset_img 2D图.png 2D图 %}
{% asset_img 3D图.png 3D图 %}