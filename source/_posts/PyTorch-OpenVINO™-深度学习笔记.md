---
title: PyTorch + OpenVINO™ 深度学习笔记
date: 2022-03-22 15:36:13
tags: [ 'PyTorch', 'OpenVINO', '深度学习' ]
---

# 一、前言
**PyTorch**是**开源**的**深度学习框架**，目的是**加速从研究原型到产品开发的过程**。其**SDK**主要基于**Python**。而其**模型训练**支持**CPU**与**GPU**、支持**分布式训练**、**云部署**，针对**深度学习特定领域**有不同的丰富的**扩展库**。

**深度学习项目**的开发大致可以分为**两个阶段**：
- 第一个阶段是**训练阶段**。这个阶段最重要的事情就是**数据采集**、**模型设计**、**训练参数调试**，**找到合适的模型**并努力训练到**满足**或者**超过**项目实际需要的**精度**。
- 第二个阶段是**部署阶段**。这个阶段最重要的事情就是把模型**移植部署**到**各种不同的计算设备**上，尽可能地实现模型规模的**小型化**、**推理预测过程**的**加速**。

相比于**PyTorch**、**TensorFlow**等为开发者所熟知的**训练框架**，**推理部署**的框架却显得有些**默默无闻**，但是它在**深度学习模型落地过程**中发挥着**不可替代**的作用。正是在这样的背景之下，**英特尔**在**2018年**发布了专门针对**CPU**、**iGPU(集成显卡)**、**FPGA**、**ARM**等**硬件单元加速**的**模型部署**与**加速推理**框架**OpenVINO™**。

**OpenVINO™**是**英特尔**发布的一套支持**快速开发视觉**、**语音识别**、**自然语言处理应用**的框架，受益于**人工智能技术**的快速发展，框架采用了最新的**人工智能神经网络**包括**卷积神经网络**、**循环神经网络**、**注意力机制网络**等模型。实现**视觉**与**非视觉**任务的**底层硬件加速**、达到**最佳性能**，支持人工智能应用从**云端**到**边缘**的**部署**与**推理**全链路技术。

# 二、PyTorch
## 1. 安装
建议使用 **Conda** 安装 **[PyTorch](https://pytorch.org/get-started/locally/)** ，本篇笔记也将以**Conda安装方式**为例。笔者的环境是**Windows11** + **[Anaconda](https://www.anaconda.com/)** + **CUDA11.6**，而**Linux**或**Mac**平台的**环境配置**大同小异，这里就不过多赘述。
### 1) CUDA版本
以**CUDA11+**为例，首先需要安装**[CUDA驱动](https://developer.nvidia.com/cuda-downloads)**
安装**完成**后，**检测安装版本**
```
nvidia-smi
```
{% asset_img CUDA11.6.png CUDA11.6 %}
* 安装**CUDA版本**
```
conda install pytorch torchvision torchaudio cudatoolkit=11.3 -c pytorch
```

### 2) CPU版本
若没有NVIDIA系显卡或其不支持CUDA加速，则可选择安装仅CPU版本。
* 安装**仅CPU版本**
```
conda install pytorch torchvision torchaudio cpuonly -c pytorch
```

## 2. 检验
在**终端**进入**Python3控制台**（笔者`python`命令**默认链接**到**Python3**）
```
python
```
导入**PyTorch**
```
import torch
```
测试`torch.rand()`函数
```
torch.rand(5, 3)
```
若**安装成功**，则会出现类似于以下的**输出**
{% asset_img 检验安装.png 检验安装 %}
测试是否支持**CUDA**
```
import torch
torch.cuda.is_available()
```
{% asset_img 测试CUDA.png 测试CUDA %}

## 3. 概念
很多人学习**深度学习框架**面临的**第一个问题**就是**其专业术语跟基本的编程概念**与**传统面向对象编程**不同，这是**初学者**面临的**第一个学习障碍**。

在**主流**的**面向对象编程语言**中，**结构化代码**最常见的**关键字**是`if`、`else`、`while`、`for`等**关键字**，而在**深度学习框架**中**编程模式**主要是基于**计算图**、**张量数据**、**自动微分**、**优化器**等组件构成。

**面向对象编程**运行的**结果**是**交互式可视化**的，而**深度学习**通过**训练模型**生成**模型文件**，然后再使用**模型预测**、**本质数据流图**的方式工作。所以学习**深度学习框架**首先必须理清**深度学习编程**中**计算图**、**张量数据**、**自动微分**、**优化器**这些**基本术语概念**，下面分别**解释**如下：

###  1) 张量
**张量(Tensor)**是**深度学习框架**中需要**理解**的**最重要**的一个**概念**，**张量**的本质是**数据**，在**深度学习框架**中一切的**数据**都可以看成**张量**。

**深度学习**中的**计算图**是以**张量数据**为**输入**，通过**算子运算**，实现对整个**计算图参数**的**评估优化**。但是到底什么是**张量**？可以看下面这张图：
{% asset_img 张量.png 张量 %}
上图中**标量**、**向量**、**数组**、**3D**、**4D**、**5D**数据矩阵在**深度学习框架**中都被称为**张量**。可见在**深度学习框架**中所有的**数据**都是**张量形式**存在，**张量**是**深度学习数据**组织与存在一种**数据类型**。

###  2) 算子/操作数
**深度学习**主要是针对**张量**的**数据操作**。这些**数据操作**从**简单**到**复杂**，多数都是以**矩阵计算**的形式存在。最常见的**矩阵操作**就是**加减乘除**，此外**卷积**、**池化**、**激活**也是**模型构建**中非常有用的**算子/操作数**。**Pytorch**支持**自定义算子操作**，可以通过**自定义算子**实现复杂的**网络结构**，构建一些特殊的**网络模型**。**张量**跟**算子/操作数**一起构成了**计算图**，它们是也是**计算图**的**基本组成要素**。

###  3) 计算图
**深度学习**基于**计算图**完成**模型构建**，实现**数据**在各个**计算图节点**之间流动，最终输出。因此**计算图**又被称为**数据流图**。

根据构建**计算图**的方式不同还可以分为**静态图**与**动态图**。**Pytorch**默认是基于**动态图**的方式构建**计算图**。

**动态图**采用类似**Python语法**，可以**随时运行**，**灵活修改调整**。

而**静态图**则是**效率优先**，但是在图**构建完成**之前无法**直接运行**。

可以看出**动态图**更加趋向于开发者平时接触的**面向对象**的编程方式，也更容易被开发者理解与接受。

下图是一个简单的**计算图**示例：
{% asset_img 计算图.png 计算图 %}
图中最底层三个**节点**表示**计算图**的**输入张量数据节点（a、b、c）**，剩下**节点**表示**操作**，带**箭头**的线段表示**数据的流向**。

###  4) 自动微分
使用**Pytorch**构建**神经网络（计算图）模型**之后，一般都是通过**反向传播**进行**训练**，**反向传播算法**使用**损失函数功能**对**神经网络**中每个**参数**根据**梯度**进行**参数值**的**调整**。

为了计算这些**梯度**完成**参数调整**，**深度学习框架**中都会自带一个叫做**自动微分**的**内置模块**，来**自动计算神经网络模型训练**时的各个**参数梯度值**并完成**参数值更新**，这种技术就是**深度学习框架**中的**自动微分**。

## 4. PyTorch基础操作
### 1) 张量的定义与声明
**张量**在**PyTorch深度学习框架**中表示**数据**，有几种不同的方式来**创建**与**声明张量数据**。

#### a. 常量声明
```
import torch

a = torch.tensor([[2., 3.], [4., 5.]])
print(a, a.dtype)
```
输出
```
tensor([[2., 3.],
        [4., 5.]]) torch.float32
```
其中`torch.tensor()`默认的**数据类型**是**flaot32**，这点从`a.dtype`的**打印结果**上也得了**印证**。

#### b. 转换声明
`torch.tensor`函数支持从**NumPy数组**直接转换为**张量数据**。
```
import numpy as np
import torch

a = torch.tensor(np.array([[1, 2], [3, 4], [5, 6], [7, 8]]))
print(a, a.dtype)
```
输出
```
tensor([[1, 2],
        [3, 4],
        [5, 6],
        [7, 8]], dtype=torch.int32) torch.int32
```
函数返回的**数据类型**将会根据**NumPy数组**自动识别。

#### c. 初始化声明
**PyTorch框架**支持类似**MATLAB**的**数组初始化方式**，可以定义数组的**维度**，然后**初始化为零**。
```
import torch

a = torch.zeros([2, 4], dtype=torch.float32)
print(a, a.dtype)
```
输出
```
tensor([[0., 0., 0., 0.],
        [0., 0., 0., 0.]]) torch.float32
```

未完待续...

# 三、OpenVINO™
未完待续...

# 四、参考
- [PyTorch + OpenVINO™ 开发实战系列教程 第一篇](https://mp.weixin.qq.com/s/qWPYYXl50cYgkCO6nOg_gQ)
- [PyTorch + OpenVINO™ 开发实战系列教程 第二篇](https://mp.weixin.qq.com/s/NaUijeZ0mDho49vXvDzCjQ)